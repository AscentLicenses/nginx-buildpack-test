#!/usr/bin/env bash
# Usage: bin/compile BUILD_DIR CACHE_DIR ENV_DIR
# https://devcenter.heroku.com/articles/buildpack-api#bin-compile

set -e

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3
echo "-----> nginx-buildpack: BUILD_DIR=$BUILD_DIR CACHE_DIR=$CACHE_DIR ENV_DIR=$ENV_DIR"

NGINX_VERSION=$(cat $ENV_DIR/NGINX_VERSION)
echo "-----> nginx-buildpack: NGINX_VERSION=$NGINX_VERSION STACK=$STACK"

# Install prerequisites (this throws 'Unable to locate package' currenly)
# apt-get install -y wget \
#                    curl \
#                    git \
#                    build-essential \
#                    autoconf \
#                    libtool \
#                    libpcre3 \
#                    libpcre3-dev \
#                    libssl-dev

# temp_dir=$(mktemp -d /tmp/nginx.XXXXXXXXXX)

cd $CACHE_DIR

curl http://nginx.org/download/nginx-$NGINX_VERSION.tar.gz | tar xz

cd nginx-$NGINX_VERSION

# Compile Nginx
./configure \
    --prefix=/etc/nginx \
    --sbin-path=/usr/sbin/nginx \
    --conf-path=/etc/nginx/nginx.conf \
    --error-log-path=/var/log/nginx/error.log \
    --http-log-path=/var/log/nginx/access.log \
    --pid-path=/var/run/nginx.pid \
    --lock-path=/var/run/nginx.lock \
    --http-client-body-temp-path=/var/cache/nginx/client_temp \
    --http-proxy-temp-path=/var/cache/nginx/proxy_temp \
    --http-fastcgi-temp-path=/var/cache/nginx/fastcgi_temp \
    --http-uwsgi-temp-path=/var/cache/nginx/uwsgi_temp \
    --http-scgi-temp-path=/var/cache/nginx/scgi_temp \
    --user=nginx \
    --group=nginx \
    --with-http_ssl_module \
    --with-http_realip_module \
    --with-http_addition_module \
    --with-http_sub_module \
    --with-http_dav_module \
    --with-http_gunzip_module \
    --with-http_gzip_static_module \
    --with-http_random_index_module \
    --with-http_secure_link_module \
    --with-http_stub_status_module \
    --with-http_auth_request_module \
    --with-threads \
    --with-stream \
    --with-stream_ssl_module \
    --with-file-aio \
    --with-cc-opt='-g -O2 -fstack-protector-strong -Wformat -Werror=format-security -Wp,-D_FORTIFY_SOURCE=2' \
    --with-ld-opt='-Wl,-z,relro -Wl,--as-needed' \
    --with-ipv6

make
make install

exit 0

cd BUILD_DIR
# mkdir -p "$1/bin/"
# cp "bin/nginx-$STACK" "$1/bin/nginx"
# nginx_version=$(./bin/nginx-$STACK -V 2>&1 | head -1 | awk '{ print $NF }')
# echo "-----> nginx-buildpack: Installed ${nginx_version} to app/bin"
# cp bin/start-nginx "$1/bin/"
# echo '-----> nginx-buildpack: Added start-nginx to app/bin'
#
# mkdir -p "$1/config"
#
# cp config/mime.types "$1/config/"
# echo '-----> nginx-buildpack: Default mime.types copied to app/config/'
#
# if [[ ! -f $1/config/nginx.conf.erb ]]; then
# 	cp config/nginx.conf.erb "$1/config/"
# 	echo '-----> nginx-buildpack: Default config copied to app/config.'
# else
# 	echo '-----> nginx-buildpack: Custom config found in app/config.'
# fi
# exit 0
